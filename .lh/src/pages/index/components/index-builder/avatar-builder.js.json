{
    "sourceFile": "src/pages/index/components/index-builder/avatar-builder.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764337392163,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764337392163,
            "name": "Commit-0",
            "content": "import \"./index-builder.scss\";\r\nimport manifestData from \"../../../../cata_manifest_handoff.json\";\r\n\r\nclass AvatarBuilder {\r\n  constructor() {\r\n    this.manifestData = manifestData;\r\n    this.selectedItems = {\r\n      tops: null,\r\n      bottoms: null,\r\n      dresses: null,\r\n      jumpsuits: null,\r\n      outerwear: null,\r\n      shoes: null,\r\n      accessories: null,\r\n    };\r\n    this.currentCategory = \"tops\";\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    if (document.readyState === \"loading\") {\r\n      document.addEventListener(\"DOMContentLoaded\", () =>\r\n        this.setupInterface()\r\n      );\r\n    } else {\r\n      this.setupInterface();\r\n    }\r\n  }\r\n\r\n  setupInterface() {\r\n    this.populateItems();\r\n    this.setupEventListeners();\r\n    this.showAvatar();\r\n  }\r\n\r\n  populateItems() {\r\n    const categories = [\r\n      \"tops\",\r\n      \"bottoms\",\r\n      \"dresses\",\r\n      \"jumpsuits\",\r\n      \"outerwear\",\r\n      \"shoes\",\r\n      \"accessories\",\r\n    ];\r\n\r\n    categories.forEach((category) => {\r\n      const container = document.getElementById(`${category}-items`);\r\n      if (!container) return;\r\n\r\n      let items = this.manifestData.items.filter(\r\n        (item) => item.category === category\r\n      );\r\n\r\n      container.innerHTML = items\r\n        .map(\r\n          (item) => `\r\n        <div class=\"item-card\" data-item-id=\"${item.id}\" data-category=\"${category}\">\r\n          <img src=\"${item.thumbPath}\" alt=\"${item.id}\" class=\"item-thumbnail\" />\r\n        </div>\r\n      `\r\n        )\r\n        .join(\"\");\r\n    });\r\n  }\r\n\r\n  setupEventListeners() {\r\n    document.querySelectorAll(\".category-tab\").forEach((tab) => {\r\n      tab.addEventListener(\"click\", (e) => {\r\n        const category = e.target.dataset.category;\r\n        this.switchCategory(category, true); // true = клік користувача\r\n      });\r\n    });\r\n\r\n    const collapseToggle = document.querySelector(\".collapse-toggle\");\r\n    if (collapseToggle) {\r\n      collapseToggle.addEventListener(\"click\", () =>\r\n        this.toggleCategoriesCollapse()\r\n      );\r\n    }\r\n\r\n    document.addEventListener(\"click\", (e) => {\r\n      if (e.target.closest(\".item-card\")) {\r\n        const card = e.target.closest(\".item-card\");\r\n        const itemId = card.dataset.itemId;\r\n        const category = card.dataset.category;\r\n        this.selectItem(itemId, category);\r\n      }\r\n    });\r\n\r\n    const clearBtn = document.getElementById(\"clear-all\");\r\n    if (clearBtn) {\r\n      clearBtn.addEventListener(\"click\", () => this.clearAll());\r\n    }\r\n\r\n    const randomBtn = document.getElementById(\"randomize\");\r\n    if (randomBtn) {\r\n      randomBtn.addEventListener(\"click\", () => this.randomLook());\r\n    }\r\n\r\n    const presetsBtn = document.getElementById(\"show-presets\");\r\n    if (presetsBtn) {\r\n      presetsBtn.addEventListener(\"click\", () => this.showPresetsModal());\r\n    }\r\n\r\n    const closePresetsBtn = document.getElementById(\"close-presets\");\r\n    if (closePresetsBtn) {\r\n      closePresetsBtn.addEventListener(\"click\", () => this.hidePresetsModal());\r\n    }\r\n\r\n    const presetsModal = document.getElementById(\"presets-modal\");\r\n    if (presetsModal) {\r\n      presetsModal.addEventListener(\"click\", (e) => {\r\n        if (e.target === presetsModal) {\r\n          this.hidePresetsModal();\r\n        }\r\n      });\r\n    }\r\n\r\n    this.setupHorizontalScroll();\r\n    this.setupZoomControls();\r\n    this.setupInfoBlocksAnimation();\r\n  }\r\n\r\n  setupInfoBlocksAnimation() {\r\n    const isMobile = window.innerWidth <= 867;\r\n\r\n    if (!isMobile) {\r\n      return;\r\n    }\r\n\r\n    const builderSection = document.getElementById(\"builder\");\r\n    if (!builderSection) return;\r\n\r\n    const infoBlocks = [\r\n      document.querySelector(\".info-block-1\"),\r\n      document.querySelector(\".info-block-2\"),\r\n      document.querySelector(\".info-block-3\"),\r\n    ].filter((block) => block !== null);\r\n\r\n    if (infoBlocks.length === 0) return;\r\n\r\n    let animationInProgress = false;\r\n    let animationTimeouts = [];\r\n    let canStartAnimation = false;\r\n\r\n    const showBlock = (block, duration = 3000) => {\r\n      return new Promise((resolve) => {\r\n        block.classList.add(\"show\");\r\n\r\n        const timeout = setTimeout(() => {\r\n          block.classList.remove(\"show\");\r\n          resolve();\r\n        }, duration);\r\n\r\n        animationTimeouts.push(timeout);\r\n      });\r\n    };\r\n\r\n    const triggerAnimation = async () => {\r\n      if (animationInProgress || !canStartAnimation) return;\r\n      animationInProgress = true;\r\n\r\n      animationTimeouts.forEach((timeout) => clearTimeout(timeout));\r\n      animationTimeouts = [];\r\n\r\n      for (const block of infoBlocks) {\r\n        await showBlock(block, 3000);\r\n        await new Promise((resolve) => {\r\n          const timeout = setTimeout(resolve, 300);\r\n          animationTimeouts.push(timeout);\r\n        });\r\n      }\r\n\r\n      setTimeout(() => {\r\n        animationInProgress = false;\r\n      }, 500);\r\n    };\r\n\r\n    const waitForTopsItemsVisible = () => {\r\n      let tops1Visible = false;\r\n      let tops6Visible = false;\r\n\r\n      const checkVisibility = () => {\r\n        // Шукаємо елементи tops_1 та tops_6\r\n        const tops1Element = document.querySelector('[data-item-id=\"tops_1\"]');\r\n        const tops6Element = document.querySelector('[data-item-id=\"tops_6\"]');\r\n\r\n        if (tops1Element && tops6Element) {\r\n          const tops1Img = tops1Element.querySelector(\"img.item-thumbnail\");\r\n          const tops6Img = tops6Element.querySelector(\"img.item-thumbnail\");\r\n\r\n          if (tops1Img && tops6Img) {\r\n            const tops1Opacity = parseFloat(\r\n              window.getComputedStyle(tops1Img).opacity\r\n            );\r\n            const tops6Opacity = parseFloat(\r\n              window.getComputedStyle(tops6Img).opacity\r\n            );\r\n\r\n            tops1Visible = tops1Opacity >= 0.9;\r\n            tops6Visible = tops6Opacity >= 0.9;\r\n\r\n            if (tops1Visible && tops6Visible && !canStartAnimation) {\r\n              canStartAnimation = true;\r\n              if (builderSectionVisible) {\r\n                triggerAnimation();\r\n              }\r\n            }\r\n          }\r\n        }\r\n      };\r\n\r\n      const visibilityInterval = setInterval(() => {\r\n        checkVisibility();\r\n\r\n        if (tops1Visible && tops6Visible) {\r\n          clearInterval(visibilityInterval);\r\n        }\r\n      }, 100);\r\n\r\n      const observer = new MutationObserver(() => {\r\n        checkVisibility();\r\n        if (tops1Visible && tops6Visible) {\r\n          observer.disconnect();\r\n        }\r\n      });\r\n\r\n      observer.observe(document.body, {\r\n        attributes: true,\r\n        attributeFilter: [\"style\"],\r\n        subtree: true,\r\n        childList: true,\r\n      });\r\n    };\r\n\r\n    waitForTopsItemsVisible();\r\n\r\n    // Intersection Observer для відстеження видимості builder секції\r\n    let builderSectionVisible = false;\r\n\r\n    const observerOptions = {\r\n      root: null,\r\n      rootMargin: \"0px\",\r\n      threshold: 0.2,\r\n    };\r\n\r\n    const observer = new IntersectionObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        builderSectionVisible = entry.isIntersecting;\r\n\r\n        if (entry.isIntersecting && !animationInProgress && canStartAnimation) {\r\n          triggerAnimation();\r\n        }\r\n      });\r\n    }, observerOptions);\r\n\r\n    observer.observe(builderSection);\r\n\r\n    // Очищення при зміні розміру вікна\r\n    const handleResize = () => {\r\n      const newIsMobile = window.innerWidth <= 867;\r\n      if (!newIsMobile) {\r\n        // Якщо переключилися на десктоп, прибираємо класи\r\n        infoBlocks.forEach((block) => {\r\n          block.classList.remove(\"show\");\r\n        });\r\n        animationTimeouts.forEach((timeout) => clearTimeout(timeout));\r\n        animationTimeouts = [];\r\n        observer.disconnect();\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\"resize\", handleResize);\r\n  }\r\n\r\n  setupHorizontalScroll() {\r\n    const scrollableElements = [\r\n      ...document.querySelectorAll(\".items-grid\"),\r\n      ...document.querySelectorAll(\".category-tabs\"),\r\n    ];\r\n\r\n    scrollableElements.forEach((element) => {\r\n      element.addEventListener(\"wheel\", (e) => {\r\n        if (element.scrollWidth > element.clientWidth) {\r\n          e.preventDefault();\r\n          const scrollAmount = e.deltaY * 2;\r\n          element.scrollLeft += scrollAmount;\r\n        }\r\n      });\r\n\r\n      let isDown = false;\r\n      let startX;\r\n      let scrollLeft;\r\n\r\n      element.addEventListener(\"mousedown\", (e) => {\r\n        if (\r\n          element.classList.contains(\"category-tabs\") &&\r\n          e.target.classList.contains(\"category-tab\")\r\n        ) {\r\n          return;\r\n        }\r\n        isDown = true;\r\n        element.style.cursor = \"grabbing\";\r\n        startX = e.pageX - element.offsetLeft;\r\n        scrollLeft = element.scrollLeft;\r\n      });\r\n\r\n      element.addEventListener(\"mouseleave\", () => {\r\n        isDown = false;\r\n        if (element.scrollWidth > element.clientWidth) {\r\n          element.style.cursor = \"grab\";\r\n        }\r\n      });\r\n\r\n      element.addEventListener(\"mouseup\", () => {\r\n        isDown = false;\r\n        if (element.scrollWidth > element.clientWidth) {\r\n          element.style.cursor = \"grab\";\r\n        }\r\n      });\r\n\r\n      element.addEventListener(\"mousemove\", (e) => {\r\n        if (!isDown) return;\r\n        e.preventDefault();\r\n        const x = e.pageX - element.offsetLeft;\r\n        const walk = (x - startX) * 2;\r\n        element.scrollLeft = scrollLeft - walk;\r\n      });\r\n\r\n      let startTouchX;\r\n      let startScrollLeft;\r\n      let touchStartTime;\r\n\r\n      element.addEventListener(\r\n        \"touchstart\",\r\n        (e) => {\r\n          startTouchX = e.touches[0].pageX;\r\n          startScrollLeft = element.scrollLeft;\r\n          touchStartTime = Date.now();\r\n        },\r\n        { passive: true }\r\n      );\r\n\r\n      element.addEventListener(\r\n        \"touchmove\",\r\n        (e) => {\r\n          if (!startTouchX) return;\r\n          if (\r\n            element.classList.contains(\"category-tabs\") &&\r\n            e.target.classList.contains(\"category-tab\")\r\n          ) {\r\n            return;\r\n          }\r\n\r\n          const touchX = e.touches[0].pageX;\r\n          const diff = startTouchX - touchX;\r\n\r\n          const isMobile = window.innerWidth <= 676;\r\n\r\n          if (isMobile && element.classList.contains(\"items-grid\")) {\r\n            element.scrollLeft = startScrollLeft + diff;\r\n          } else {\r\n            const walk = diff * 1.5;\r\n            element.scrollLeft = startScrollLeft + walk;\r\n          }\r\n        },\r\n        { passive: true }\r\n      );\r\n\r\n      element.addEventListener(\r\n        \"touchend\",\r\n        (e) => {\r\n          if (!startTouchX) return;\r\n\r\n          const isMobile = window.innerWidth <= 676;\r\n\r\n          if (isMobile && element.classList.contains(\"items-grid\")) {\r\n            const touchEndTime = Date.now();\r\n            const touchDuration = touchEndTime - touchStartTime;\r\n            const touchDistance = startScrollLeft - element.scrollLeft;\r\n\r\n            const velocity = Math.abs(touchDistance / touchDuration);\r\n\r\n            const itemWidth = 72;\r\n            const itemsPerSnap = 4;\r\n            const snapDistance = itemWidth * 2;\r\n\r\n            let targetScroll = element.scrollLeft;\r\n\r\n            if (Math.abs(touchDistance) > 30) {\r\n              if (velocity > 0.3) {\r\n                const direction = touchDistance > 0 ? -1 : 1;\r\n                const currentSnapIndex = Math.round(\r\n                  element.scrollLeft / snapDistance\r\n                );\r\n                targetScroll = (currentSnapIndex + direction) * snapDistance;\r\n              } else {\r\n                targetScroll =\r\n                  Math.round(element.scrollLeft / snapDistance) * snapDistance;\r\n              }\r\n            } else {\r\n              targetScroll =\r\n                Math.round(element.scrollLeft / snapDistance) * snapDistance;\r\n            }\r\n\r\n            targetScroll = Math.max(\r\n              0,\r\n              Math.min(targetScroll, element.scrollWidth - element.clientWidth)\r\n            );\r\n\r\n            element.scrollTo({\r\n              left: targetScroll,\r\n              behavior: \"smooth\",\r\n            });\r\n          }\r\n\r\n          startTouchX = null;\r\n          touchStartTime = null;\r\n        },\r\n        { passive: true }\r\n      );\r\n\r\n      if (\r\n        element.scrollWidth > element.clientWidth &&\r\n        !(\"ontouchstart\" in window)\r\n      ) {\r\n        element.style.cursor = \"grab\";\r\n      }\r\n    });\r\n  }\r\n\r\n  switchCategory(category, isUserClick = false) {\r\n    this.currentCategory = category;\r\n\r\n    document.querySelectorAll(\".category-tab\").forEach((tab) => {\r\n      tab.classList.toggle(\"active\", tab.dataset.category === category);\r\n    });\r\n\r\n    document.querySelectorAll(\".items-grid\").forEach((grid) => {\r\n      grid.classList.toggle(\"active\", grid.id === `${category}-items`);\r\n    });\r\n    \r\n    // Прокручуємо активний таб до центру тільки при кліку користувача\r\n    if (isUserClick) {\r\n      const activeTab = document.querySelector(`.category-tab[data-category=\"${category}\"]`);\r\n      const categoryTabsContainer = document.querySelector(\".category-tabs\");\r\n      \r\n      if (activeTab && categoryTabsContainer) {\r\n        // Отримуємо позиції елементів\r\n        const tabRect = activeTab.getBoundingClientRect();\r\n        const containerRect = categoryTabsContainer.getBoundingClientRect();\r\n        \r\n        // Обчислюємо зсув для центрування\r\n        const tabCenter = tabRect.left + tabRect.width / 2;\r\n        const containerCenter = containerRect.left + containerRect.width / 2;\r\n        const scrollOffset = tabCenter - containerCenter;\r\n        \r\n        // Плавно прокручуємо\r\n        categoryTabsContainer.scrollBy({\r\n          left: scrollOffset,\r\n          behavior: 'smooth'\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  selectItem(itemId, category) {\r\n    const itemData = this.manifestData.items.find((item) => item.id === itemId);\r\n    if (!itemData) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      this.selectedItems[category] &&\r\n      this.selectedItems[category].id !== itemId\r\n    ) {\r\n      this.clearLayer(category);\r\n    }\r\n\r\n    const previousSelection = this.selectedItems[category];\r\n    this.selectedItems[category] = itemData;\r\n\r\n    this.checkReverseCompatibility(category, itemId);\r\n    this.applyClearingRules(category, itemId);\r\n    this.showClothingItem(itemData, category);\r\n    this.updateItemSelection(itemId, category);\r\n  }\r\n\r\n  /**\r\n   * Застосовує правила взаємного виключення категорій одягу\r\n   * Логіка:\r\n   * - Dresses виключають: tops, bottoms, jumpsuits (сукня це цілісний образ)\r\n   * - Jumpsuits виключають: tops, bottoms, dresses (комбінезон це цілісний образ)\r\n   * - Tops/Bottoms виключають: dresses, jumpsuits (роздільний одяг несумісний з цілісним)\r\n   * - Спеціальні правила для конкретних предметів з itemSpecificRules\r\n   */\r\n\r\n  applyClearingRules(selectedCategory, selectedItemId = null) {\r\n    const clearingRules = {\r\n      dresses: [\"tops\", \"bottoms\", \"jumpsuits\"],\r\n      jumpsuits: [\"tops\", \"bottoms\", \"dresses\"],\r\n      tops: [\"dresses\", \"jumpsuits\"],\r\n      bottoms: [\"dresses\", \"jumpsuits\"],\r\n    };\r\n\r\n    if (selectedItemId && this.manifestData.rules.itemSpecificRules) {\r\n      const itemRules =\r\n        this.manifestData.rules.itemSpecificRules[selectedItemId];\r\n      if (itemRules) {\r\n        if (itemRules.incompatibleCategories) {\r\n          itemRules.incompatibleCategories.forEach((categoryToClear) => {\r\n            if (this.selectedItems[categoryToClear]) {\r\n              this.selectedItems[categoryToClear] = null;\r\n              this.clearLayer(categoryToClear);\r\n            }\r\n          });\r\n        }\r\n\r\n        if (itemRules.incompatibleItems) {\r\n          itemRules.incompatibleItems.forEach((incompatibleItemId) => {\r\n            const allCategories = [\r\n              \"tops\",\r\n              \"bottoms\",\r\n              \"dresses\",\r\n              \"jumpsuits\",\r\n              \"outerwear\",\r\n              \"shoes\",\r\n              \"accessories\",\r\n            ];\r\n            allCategories.forEach((cat) => {\r\n              if (\r\n                this.selectedItems[cat] &&\r\n                this.selectedItems[cat].id === incompatibleItemId\r\n              ) {\r\n                this.selectedItems[cat] = null;\r\n                this.clearLayer(cat);\r\n              }\r\n            });\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    const categoriesToClear = clearingRules[selectedCategory];\r\n\r\n    if (categoriesToClear && categoriesToClear.length > 0) {\r\n      categoriesToClear.forEach((categoryToClear) => {\r\n        if (this.selectedItems[categoryToClear]) {\r\n          this.selectedItems[categoryToClear] = null;\r\n          this.clearLayer(categoryToClear);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  checkReverseCompatibility(selectedCategory, selectedItemId) {\r\n    if (!this.manifestData.rules.itemSpecificRules) {\r\n      return;\r\n    }\r\n\r\n    if (selectedCategory === \"outerwear\") {\r\n      const incompatibleDresses = [\r\n        \"dresses_2\",\r\n        \"dresses_5\",\r\n        \"dresses_8\",\r\n        \"dresses_12\",\r\n      ];\r\n\r\n      if (this.selectedItems.dresses) {\r\n        const selectedDressId = this.selectedItems.dresses.id;\r\n\r\n        if (incompatibleDresses.includes(selectedDressId)) {\r\n          this.selectedItems.dresses = null;\r\n          this.clearLayer(\"dresses\");\r\n        }\r\n      }\r\n\r\n      const incompatibleJumpsuits = [\r\n        \"jumpsuits_1\",\r\n        \"jumpsuits_3\",\r\n        \"jumpsuits_5\",\r\n        \"jumpsuits_6\",\r\n        \"jumpsuits_7\",\r\n        \"jumpsuits_8\",\r\n      ];\r\n\r\n      if (this.selectedItems.jumpsuits) {\r\n        const selectedJumpsuitId = this.selectedItems.jumpsuits.id;\r\n\r\n        if (incompatibleJumpsuits.includes(selectedJumpsuitId)) {\r\n          this.selectedItems.jumpsuits = null;\r\n          this.clearLayer(\"jumpsuits\");\r\n        }\r\n      }\r\n    }\r\n\r\n    if (selectedCategory === \"dresses\") {\r\n      const incompatibleDresses = [\r\n        \"dresses_2\",\r\n        \"dresses_5\",\r\n        \"dresses_8\",\r\n        \"dresses_12\",\r\n      ];\r\n\r\n      if (incompatibleDresses.includes(selectedItemId)) {\r\n        if (this.selectedItems.outerwear) {\r\n          this.selectedItems.outerwear = null;\r\n          this.clearLayer(\"outerwear\");\r\n        }\r\n      }\r\n    }\r\n\r\n    if (selectedCategory === \"jumpsuits\") {\r\n      const incompatibleJumpsuits = [\r\n        \"jumpsuits_1\",\r\n        \"jumpsuits_3\",\r\n        \"jumpsuits_5\",\r\n        \"jumpsuits_6\",\r\n        \"jumpsuits_7\",\r\n        \"jumpsuits_8\",\r\n      ];\r\n\r\n      if (incompatibleJumpsuits.includes(selectedItemId)) {\r\n        if (this.selectedItems.outerwear) {\r\n          this.selectedItems.outerwear = null;\r\n          this.clearLayer(\"outerwear\");\r\n        }\r\n      }\r\n    }\r\n\r\n    Object.keys(this.selectedItems).forEach((category) => {\r\n      const selectedItem = this.selectedItems[category];\r\n      if (selectedItem && category !== selectedCategory) {\r\n        const itemRules =\r\n          this.manifestData.rules.itemSpecificRules[selectedItem.id];\r\n        if (itemRules) {\r\n          if (\r\n            itemRules.incompatibleCategories &&\r\n            itemRules.incompatibleCategories.includes(selectedCategory)\r\n          ) {\r\n            this.selectedItems[category] = null;\r\n            this.clearLayer(category);\r\n          }\r\n\r\n          if (\r\n            itemRules.incompatibleItems &&\r\n            itemRules.incompatibleItems.includes(selectedItemId)\r\n          ) {\r\n            this.selectedItems[category] = null;\r\n            this.clearLayer(category);\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  showClothingItem(itemData, category) {\r\n    const layer = document.getElementById(`${category}-layer`);\r\n    if (!layer) {\r\n      return;\r\n    }\r\n\r\n    if (itemData.sublayers) {\r\n      this.handleSublayers(itemData, category);\r\n    } else {\r\n      layer.src = itemData.garmentPath;\r\n      layer.style.display = \"block\";\r\n      layer.style.zIndex = this.getZIndex(itemData, category);\r\n    }\r\n  }\r\n\r\n  clearLayer(category) {\r\n    const layer = document.getElementById(`${category}-layer`);\r\n    if (layer) {\r\n      layer.style.display = \"none\";\r\n      layer.src = \"\";\r\n    }\r\n\r\n    const backLayer = document.getElementById(`${category}-back-layer`);\r\n    if (backLayer) {\r\n      backLayer.style.display = \"none\";\r\n      backLayer.src = \"\";\r\n    }\r\n\r\n    const frontLayer = document.getElementById(`${category}-front-layer`);\r\n    if (frontLayer) {\r\n      frontLayer.style.display = \"none\";\r\n      frontLayer.src = \"\";\r\n    }\r\n  }\r\n\r\n  getZIndex(itemData, category) {\r\n    if (itemData.zIndexOverride) {\r\n      return itemData.zIndexOverride;\r\n    }\r\n\r\n    const zIndexMap = this.manifestData.rules?.zOrder || {\r\n      shoes: 200,\r\n      bottoms: 300,\r\n      dresses: 350,\r\n      jumpsuits: 360,\r\n      tops: 400,\r\n      outerwear: 500,\r\n      accessories: 600,\r\n    };\r\n\r\n    return zIndexMap[category] || 300;\r\n  }\r\n\r\n  handleSublayers(itemData, category) {\r\n    if (itemData.sublayers.backPath && itemData.sublayers.frontPath) {\r\n      const backLayer = document.getElementById(`${category}-back-layer`);\r\n      const frontLayer = document.getElementById(`${category}-front-layer`);\r\n\r\n      if (backLayer && frontLayer) {\r\n        backLayer.src = itemData.sublayers.backPath;\r\n        backLayer.style.display = \"block\";\r\n\r\n        frontLayer.src = itemData.sublayers.frontPath;\r\n        frontLayer.style.display = \"block\";\r\n      }\r\n    }\r\n  }\r\n\r\n  updateItemSelection(selectedItemId, category) {\r\n    const allCategories = [\r\n      \"tops\",\r\n      \"bottoms\",\r\n      \"dresses\",\r\n      \"jumpsuits\",\r\n      \"outerwear\",\r\n      \"shoes\",\r\n      \"accessories\",\r\n    ];\r\n\r\n    allCategories.forEach((cat) => {\r\n      document.querySelectorAll(`#${cat}-items .item-card`).forEach((card) => {\r\n        if (\r\n          !this.selectedItems[cat] ||\r\n          card.dataset.itemId !== this.selectedItems[cat].id\r\n        ) {\r\n          card.classList.remove(\"selected\");\r\n        }\r\n      });\r\n    });\r\n\r\n    const selectedCard = document.querySelector(\r\n      `[data-item-id=\"${selectedItemId}\"]`\r\n    );\r\n    if (selectedCard) {\r\n      selectedCard.classList.add(\"selected\");\r\n    }\r\n  }\r\n\r\n  showAvatar() {\r\n    const avatarBase = document.getElementById(\"avatar-base\");\r\n    if (avatarBase) {\r\n      avatarBase.onload = () => {};\r\n    }\r\n  }\r\n\r\n  clearAll() {\r\n    Object.keys(this.selectedItems).forEach((category) => {\r\n      this.selectedItems[category] = null;\r\n      this.clearLayer(category);\r\n    });\r\n\r\n    const allCategories = [\r\n      \"tops\",\r\n      \"bottoms\",\r\n      \"dresses\",\r\n      \"jumpsuits\",\r\n      \"outerwear\",\r\n      \"shoes\",\r\n      \"accessories\",\r\n    ];\r\n    allCategories.forEach((category) => {\r\n      document\r\n        .querySelectorAll(`#${category}-items .item-card`)\r\n        .forEach((card) => {\r\n          card.classList.remove(\"selected\");\r\n        });\r\n    });\r\n  }\r\n\r\n  randomLook() {\r\n    this.clearAll();\r\n\r\n    const presets = this.manifestData.ui?.presets || [];\r\n    if (presets.length === 0) return;\r\n\r\n    const randomPreset = presets[Math.floor(Math.random() * presets.length)];\r\n\r\n    randomPreset.items.forEach((itemId) => {\r\n      const itemData = this.manifestData.items.find(\r\n        (item) => item.id === itemId\r\n      );\r\n      if (itemData) {\r\n        this.selectItem(itemId, itemData.category);\r\n      }\r\n    });\r\n  }\r\n\r\n  getCategoryStats() {\r\n    const stats = {};\r\n    const categories = [\r\n      \"tops\",\r\n      \"bottoms\",\r\n      \"dresses\",\r\n      \"jumpsuits\",\r\n      \"outerwear\",\r\n      \"shoes\",\r\n      \"accessories\",\r\n    ];\r\n\r\n    categories.forEach((category) => {\r\n      const items = this.manifestData.items.filter(\r\n        (item) => item.category === category\r\n      );\r\n      stats[category] = items.length;\r\n\r\n      if (category === \"accessories\") {\r\n        const subtypes = {};\r\n        items.forEach((item) => {\r\n          const subtype = item.subtype || \"other\";\r\n          subtypes[subtype] = (subtypes[subtype] || 0) + 1;\r\n        });\r\n        stats[`${category}_subtypes`] = subtypes;\r\n      }\r\n    });\r\n\r\n    return stats;\r\n  }\r\n\r\n  showPresetsModal() {\r\n    const modal = document.getElementById(\"presets-modal\");\r\n    const presetsGrid = document.getElementById(\"presets-grid\");\r\n\r\n    if (!modal || !presetsGrid) return;\r\n\r\n    const presets = this.manifestData.ui?.presets || [];\r\n    presetsGrid.innerHTML = presets\r\n      .map(\r\n        (preset) => `\r\n      <div class=\"preset-card\" data-preset-name=\"${preset.name}\">\r\n        <h4 class=\"preset-name\">${preset.name}</h4>\r\n        <div class=\"preset-items\">\r\n          ${preset.items\r\n            .slice(0, 4)\r\n            .map((itemId) => {\r\n              const item = this.manifestData.items.find((i) => i.id === itemId);\r\n              return item\r\n                ? `<img src=\"${item.thumbPath}\" alt=\"${itemId}\" class=\"preset-item-thumb\" />`\r\n                : \"\";\r\n            })\r\n            .join(\"\")}\r\n        </div>\r\n        <button class=\"apply-preset-btn\" data-preset-name=\"${\r\n          preset.name\r\n        }\">Apply Look</button>\r\n      </div>\r\n    `\r\n      )\r\n      .join(\"\");\r\n\r\n    presetsGrid.querySelectorAll(\".apply-preset-btn\").forEach((btn) => {\r\n      btn.addEventListener(\"click\", (e) => {\r\n        const presetName = e.target.dataset.presetName;\r\n        this.applyPreset(presetName);\r\n        this.hidePresetsModal();\r\n      });\r\n    });\r\n\r\n    modal.style.display = \"flex\";\r\n  }\r\n\r\n  hidePresetsModal() {\r\n    const modal = document.getElementById(\"presets-modal\");\r\n    if (modal) {\r\n      modal.style.display = \"none\";\r\n    }\r\n  }\r\n\r\n  applyPreset(presetName) {\r\n    const preset = this.manifestData.ui?.presets.find(\r\n      (p) => p.name === presetName\r\n    );\r\n    if (!preset) return;\r\n\r\n    this.clearAll();\r\n\r\n    preset.items.forEach((itemId) => {\r\n      const itemData = this.manifestData.items.find(\r\n        (item) => item.id === itemId\r\n      );\r\n      if (itemData) {\r\n        this.selectItem(itemId, itemData.category);\r\n      }\r\n    });\r\n  }\r\n\r\n  setupZoomControls() {\r\n    const avatarContainer = document.querySelector(\".avatar-container\");\r\n    const zoomSlider = document.getElementById(\"zoom-slider\");\r\n    const zoomInBtn = document.getElementById(\"zoom-in\");\r\n    const zoomOutBtn = document.getElementById(\"zoom-out\");\r\n\r\n    if (!avatarContainer || !zoomSlider || !zoomInBtn || !zoomOutBtn) {\r\n      return;\r\n    }\r\n\r\n    let currentZoom = 1;\r\n\r\n    let dragOffset = { x: 0, y: 0 };\r\n    let isDragging = false;\r\n    let dragStart = { x: 0, y: 0 };\r\n\r\n    const applyZoom = (zoomValue) => {\r\n      currentZoom = zoomValue;\r\n\r\n      clampPosition();\r\n\r\n      const avatarBase = avatarContainer.querySelector(\"#avatar-base\");\r\n      const clothingLayers = avatarContainer.querySelector(\".clothing-layers\");\r\n\r\n      const transform = `translate(${dragOffset.x}px, ${dragOffset.y}px) scale(${zoomValue})`;\r\n\r\n      if (avatarBase) {\r\n        avatarBase.style.transform = transform;\r\n        avatarBase.style.transformOrigin = \"center center\";\r\n      }\r\n\r\n      if (clothingLayers) {\r\n        clothingLayers.style.transform = transform;\r\n        clothingLayers.style.transformOrigin = \"center center\";\r\n      }\r\n\r\n      zoomSlider.value = zoomValue;\r\n\r\n      if (zoomValue > 1) {\r\n        avatarContainer.style.cursor = \"grab\";\r\n      } else {\r\n        avatarContainer.style.cursor = \"default\";\r\n        dragOffset = { x: 0, y: 0 };\r\n        applyTransform();\r\n      }\r\n    };\r\n\r\n    const calculateDragBounds = () => {\r\n      const containerRect = avatarContainer.getBoundingClientRect();\r\n      const containerWidth = containerRect.width;\r\n      const containerHeight = containerRect.height;\r\n\r\n      if (currentZoom <= 1) {\r\n        return { minX: 0, maxX: 0, minY: 0, maxY: 0 };\r\n      }\r\n\r\n      const overflowX = (containerWidth * currentZoom - containerWidth) / 2;\r\n      const overflowY = (containerHeight * currentZoom - containerHeight) / 2;\r\n\r\n      const maxOffsetX = overflowX / currentZoom;\r\n      const maxOffsetY = overflowY / currentZoom;\r\n\r\n      const verticalExtension = maxOffsetY * 0.8;\r\n\r\n      return {\r\n        minX: -maxOffsetX,\r\n        maxX: maxOffsetX,\r\n        minY: -maxOffsetY - verticalExtension,\r\n        maxY: maxOffsetY + verticalExtension,\r\n      };\r\n    };\r\n\r\n    const clampPosition = () => {\r\n      if (currentZoom <= 1) {\r\n        dragOffset = { x: 0, y: 0 };\r\n        return;\r\n      }\r\n\r\n      const bounds = calculateDragBounds();\r\n\r\n      dragOffset.x = Math.max(bounds.minX, Math.min(bounds.maxX, dragOffset.x));\r\n      dragOffset.y = Math.max(bounds.minY, Math.min(bounds.maxY, dragOffset.y));\r\n    };\r\n\r\n    const applyTransform = () => {\r\n      clampPosition();\r\n\r\n      const avatarBase = avatarContainer.querySelector(\"#avatar-base\");\r\n      const clothingLayers = avatarContainer.querySelector(\".clothing-layers\");\r\n\r\n      const transform = `translate(${dragOffset.x}px, ${dragOffset.y}px) scale(${currentZoom})`;\r\n\r\n      if (avatarBase) {\r\n        avatarBase.style.transform = transform;\r\n        avatarBase.style.transformOrigin = \"center center\";\r\n      }\r\n\r\n      if (clothingLayers) {\r\n        clothingLayers.style.transform = transform;\r\n        clothingLayers.style.transformOrigin = \"center center\";\r\n      }\r\n    };\r\n\r\n    avatarContainer.addEventListener(\"mousedown\", (e) => {\r\n      if (e.target.closest(\".zoom-controls\")) return;\r\n\r\n      if (currentZoom > 1) {\r\n        isDragging = true;\r\n        avatarContainer.style.cursor = \"grabbing\";\r\n        dragStart.x = e.clientX - dragOffset.x;\r\n        dragStart.y = e.clientY - dragOffset.y;\r\n        e.preventDefault();\r\n      }\r\n    });\r\n\r\n    document.addEventListener(\"mousemove\", (e) => {\r\n      if (isDragging && currentZoom > 1) {\r\n        dragOffset.x = e.clientX - dragStart.x;\r\n        dragOffset.y = e.clientY - dragStart.y;\r\n        applyTransform();\r\n      }\r\n    });\r\n\r\n    document.addEventListener(\"mouseup\", () => {\r\n      if (isDragging) {\r\n        isDragging = false;\r\n        if (currentZoom > 1) {\r\n          avatarContainer.style.cursor = \"grab\";\r\n        }\r\n      }\r\n    });\r\n\r\n    let touchStart = { x: 0, y: 0 };\r\n\r\n    avatarContainer.addEventListener(\r\n      \"touchstart\",\r\n      (e) => {\r\n        if (\r\n          e.target.closest(\".zoom-controls\") ||\r\n          e.target.classList.contains(\"zoom-btn\") ||\r\n          e.target.closest(\".zoom-btn\")\r\n        ) {\r\n          return;\r\n        }\r\n\r\n        if (currentZoom > 1 && e.touches.length === 1) {\r\n          const touch = e.touches[0];\r\n          touchStart.x = touch.clientX - dragOffset.x;\r\n          touchStart.y = touch.clientY - dragOffset.y;\r\n          e.preventDefault();\r\n        }\r\n      },\r\n      { passive: false }\r\n    );\r\n\r\n    avatarContainer.addEventListener(\"touchmove\", (e) => {\r\n      if (currentZoom > 1 && e.touches.length === 1) {\r\n        const touch = e.touches[0];\r\n        dragOffset.x = touch.clientX - touchStart.x;\r\n        dragOffset.y = touch.clientY - touchStart.y;\r\n        applyTransform();\r\n        e.preventDefault();\r\n      }\r\n    });\r\n\r\n    zoomSlider.addEventListener(\"input\", (e) => {\r\n      const zoomValue = parseFloat(e.target.value);\r\n      applyZoom(zoomValue);\r\n    });\r\n\r\n    // Додаємо обробник для touch на slider\r\n    zoomSlider.addEventListener(\"change\", (e) => {\r\n      const zoomValue = parseFloat(e.target.value);\r\n      applyZoom(zoomValue);\r\n    });\r\n\r\n    zoomSlider.addEventListener(\r\n      \"touchstart\",\r\n      (e) => {\r\n        e.stopPropagation();\r\n      },\r\n      { passive: true }\r\n    );\r\n\r\n    zoomSlider.addEventListener(\r\n      \"touchmove\",\r\n      (e) => {\r\n        e.stopPropagation();\r\n      },\r\n      { passive: true }\r\n    );\r\n\r\n    // Обробники для кнопок zoom-in\r\n    zoomInBtn.addEventListener(\"click\", (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const newZoom = Math.min(currentZoom + 0.1, 2);\r\n      applyZoom(newZoom);\r\n    });\r\n\r\n    zoomInBtn.addEventListener(\r\n      \"touchstart\",\r\n      (e) => {\r\n        e.stopPropagation();\r\n      },\r\n      { passive: true }\r\n    );\r\n\r\n    // Обробники для кнопок zoom-out\r\n    zoomOutBtn.addEventListener(\"click\", (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const newZoom = Math.max(currentZoom - 0.1, 1);\r\n      applyZoom(newZoom);\r\n    });\r\n\r\n    zoomOutBtn.addEventListener(\r\n      \"touchstart\",\r\n      (e) => {\r\n        e.stopPropagation();\r\n      },\r\n      { passive: true }\r\n    );\r\n\r\n    avatarContainer.addEventListener(\"wheel\", (e) => {\r\n      if (e.ctrlKey || e.metaKey) {\r\n        e.preventDefault();\r\n        const delta = e.deltaY > 0 ? -0.1 : 0.1;\r\n        const newZoom = Math.max(1, Math.min(2, currentZoom + delta));\r\n        applyZoom(newZoom);\r\n      }\r\n    });\r\n  }\r\n\r\n  toggleCategoriesCollapse() {\r\n    const avatarContainer = document.querySelector(\".avatar-container\");\r\n    const collapseToggle = document.querySelector(\".collapse-toggle\");\r\n\r\n    if (!avatarContainer) return;\r\n\r\n    const isCollapsed = avatarContainer.classList.contains(\r\n      \"categories-collapsed\"\r\n    );\r\n\r\n    if (isCollapsed) {\r\n      avatarContainer.classList.remove(\"categories-collapsed\");\r\n      collapseToggle.classList.remove(\"collapsed\");\r\n    } else {\r\n      avatarContainer.classList.add(\"categories-collapsed\");\r\n      collapseToggle.classList.add(\"collapsed\");\r\n    }\r\n  }\r\n}\r\n\r\nconst avatarBuilder = new AvatarBuilder();\r\n\r\nexport default avatarBuilder;\r\n"
        }
    ]
}